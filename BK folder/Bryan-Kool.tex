\documentclass{amsart}

\title{Donaldson-Thomas invariants of local elliptic surfaces via the topological vertex}
\author{Jim Bryan and Martijn Kool}
\date{\today}
\address{
Department of Mathematics\\
University of British Columbia \\
Room 121, 1984 Mathematics Road  \\
Vancouver, B.C., Canada V6T 1Z2  
}


%\usepackage{diagrams}
%\usepackage{eepic,epic}

\usepackage{amsmath}
\usepackage{amsmath,amsthm,amsfonts}
\usepackage{amssymb}
\usepackage{times}
\usepackage[all]{xy}
%\usepackage{amstex}
\usepackage[colorinlistoftodos]{todonotes}



%\newtheorem{thm}{Theorem}%[section]
\newtheorem{theorem}{Theorem}%[section]
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{conjecture}[theorem]{Conjecture}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{corollary}[theorem]{Corollary}
\theoremstyle{definition}

\newtheorem{def-theorem}[theorem]{Definition-Theorem}
\newtheorem{remark}[theorem]{Remark}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{example}[theorem]{Example}


\newcommand{\CC} {\mathbb{C}}          % complex numbers
\newcommand{\NN} {\mathbb{N}}		% natural numbers
\newcommand{\RR} {\mathbb{R}}		% real numbers
\newcommand{\ZZ} {\mathbb{Z}}		% integers
\newcommand{\QQ} {\mathbb{Q}}		% rationals
\newcommand{\PP} {\mathbb{P}}
\renewcommand{\AA} {\mathbb{A}}
\newcommand{\LL} {\mathbb{L}}
\newcommand{\FF} {\mathbb{F}}
\renewcommand{\O}{\mathcal{O}}
\newcommand{\sfV}{\mathsf{V}}


\newcommand{\rt}[1]{\stackrel{#1\,}{\rightarrow}}
\newcommand{\Rt}[1]{\stackrel{#1\,}{\longrightarrow}}
\newcommand\To{\longrightarrow}
\newcommand\into{\hookrightarrow}
\newcommand\Into{\ensuremath{\lhook\joinrel\relbar\joinrel\rightarrow}}
\newcommand\INTO{\ar@{^{(}->}[r]}
\newcommand\acts{\curvearrowright}


\newcommand{\Hom}{\operatorname{Hom}}
\newcommand{\Ker}{\operatorname{Ker}}
\newcommand{\End}{\operatorname{End}}
\newcommand{\GL}{\operatorname{GL}}
\newcommand{\Tr}{\operatorname{tr}}
\newcommand{\tr}{\operatorname{tr}}
\newcommand{\Coker}{\operatorname{Coker}}
\newcommand{\im}{\operatorname{Im}}
\newcommand{\M}{\overline{\mathcal{M}}}
\newcommand{\smargin}[1]{\marginpar{\tiny{#1}}}
\newcommand{\Sym}{\operatorname{Sym}}
\newcommand{\Coh}{\operatorname{Coh}}
\newcommand{\Hilb}{\operatorname{Hilb}}
\newcommand{\DT}{\operatorname{DT}}
\newcommand{\Var}{\operatorname{Var}}
\newcommand{\supp}{\operatorname{supp}}
\newcommand{\Spec}{\operatorname{Spec}}
\newcommand{\sm}{\operatorname{sm}}
\newcommand{\sing}{\operatorname{sing}}
\newcommand{\conn}{\operatorname{conn}}
\newcommand{\F}{\mathcal{F}}
\newcommand{\G}{\mathcal{G}}

\begin{document}

\begin{abstract}
%Jim's original:

We compute the Donaldson-Thomas invariants of a local elliptic surface
with section. We introduce a new computational technique which is a
mixture of motivic and toric methods. This allows us to write the
partition function for the invariants in terms of the topological
vertex. Utilizing identities for the topological vertex (some
previously known, some new), we derive product formulas for the
partition functions in a companion paper with B.~Young. In the special case where the elliptic surface is
a K3 surface, we get a new proof of the Katz-Klemm-Vafa formula.
\end{abstract}

\maketitle 

%\markboth{???}  {???}
%\renewcommand{\sectionmark}[1]{}


%\tableofcontents
%\pagebreak


\section{Introduction}

Let $p : S \rightarrow B$ be an elliptic surface over a smooth projective curve $B$. We assume $p$ has a unique section \todo{Drop uniqueness so generating function becomes product with contribution from multiple sections?} and all singular fibres are rational nodal curves. Let $N$ be the number of singular fibres. An important example is the elliptically fibred K3 surface $p : S \rightarrow \PP^1$ for which $N=24$.

We are interested in the Donaldson-Thomas invariants of $X = \mathrm{Tot}(K_S)$, i.e.~the total space of the canonical bundle $K_S$. This is a non-compact Calabi-Yau 3-fold. Let $\beta$ be an effective curve class on $S$. Consider the Hilbert scheme 
$$
\Hilb^{\beta,n}(X) = \{ Z \subset X \ : \ [Z] = \beta, \ \chi(\O_Z) = n\}
$$
of proper subschemes $Z \subset X$ with homology class $\beta$ and holomorphic Euler characteristics $n$. The DT invariants of $X$ can be defined as
$$
\DT_{\beta,n}(X) := e(\Hilb^{\beta,n}(X), \nu) := \sum_{k \in \ZZ} k \ e(\nu^{-1}(\{k\})),
$$
where $e(\cdot)$ denotes topological Euler characteristic and $\nu : \Hilb^{\beta,n}(X) \rightarrow \ZZ$ is Behrend's constructible function \cite{Beh}. We consider an Euler characteristic version of these invariants
$$
\widehat{\DT}_{\beta,n}(X) := e(\Hilb^{\beta,n}(X)).
$$
We focus on primitive classes $\beta = B + dF$, where $B$ is the class of the section and $F$ the class of the fibre. Let 
\begin{align*}
\widehat{\DT}(X) := \sum_{d \geq 0} \widehat{\DT}_d(X) q^d := \sum_{d \geq 0} \sum_{n \in \ZZ} \widehat{\DT}_{B+dF,n}(X) p^n q^d.
\end{align*}
Our main result is an explicit expression for this generating function (and its connected analog $\widehat{\DT}^{\conn}(X)$). Before phrasing the result, we introduce some notation: for a 2D partition $\lambda = (\lambda_0 \geq \lambda_1 \geq \cdots)$, we write $\lambda'$ for the corresponding transposed partition and 
\begin{align*}
|\lambda| &:= \sum_{k=0}^{\infty} \lambda_k, \\
|\!|\lambda|\!| &:= \sum_{k=0}^{\infty} \lambda_{k}^{2}.
\end{align*}
\begin{theorem} \label{main}
%For any elliptic surface $p : S \rightarrow B$ over a smooth projective curve $B$ with unique section, $N$ rational nodal fibres and no further singular fibres, we have
\begin{align*}
\widehat{\DT}(X) &= \frac{1}{(p^{\frac{1}{2}} - p^{-\frac{1}{2}})^{e(B)}} \Bigg( \sum_{\lambda} \frac{\sfV_{\lambda,\square,\varnothing}(p)}{\sfV_{\lambda,\varnothing,\varnothing}(p)} q^{|\lambda|} \Bigg)^{e(B) - N}  \Bigg( \sum_{\mu} \frac{\sfV_{\mu,\square,\varnothing}(p) \sfV_{\mu,\mu',\varnothing}(p) p^{|\!|\mu|\!|}}{\sfV_{\mu,\varnothing,\varnothing}(p)} q^{|\mu|} \Bigg)^{N} \\
\widehat{\DT}^{\conn}(X) &= \frac{1}{(p^{\frac{1}{2}} - p^{-\frac{1}{2}})^{e(B)}} \Bigg( \frac{\sum_{\lambda} \frac{\sfV_{\lambda,\square,\varnothing}(p)}{\sfV_{\lambda,\varnothing,\varnothing}(p)} q^{|\lambda|}}{\sum_{\lambda} q^{|\lambda|}} \Bigg)^{e(B) - N}  \Bigg( \frac{\sum_{\mu} \frac{\sfV_{\mu,\square,\varnothing}(p) \sfV_{\mu,\mu',\varnothing}(p) p^{\binom{\mu}{2} +|\mu|}}{\sfV_{\mu,\varnothing,\varnothing}(p)} q^{|\mu|}}{\sum_{\mu} \sfV_{\mu, \mu', \varnothing}(p) p^{|\!|\mu|\!|} q^{|\mu|}} \Bigg)^{N}.
\end{align*}
where the sums are over all 2D partitions and where $\sfV_{\lambda,\mu,\nu}(p)$ denotes the topological vertex.
\end{theorem}

It turns out the sums over partitions in Theorem \ref{main} can be computed. They can be expressed in terms of traces of certain natural operators on Fock space. Some of them are known and some of them are new. The way to compute these traces is of independent interest and forms the subject of a purely combinatorial companion paper with B.~Young \cite{BKY}. Combining Theorem \ref{main} with the calculations of \cite{BKY} gives:
\begin{corollary}[Bryan-Kool-Young]
$$
\widehat{\DT}^{\conn}(X) = \frac{1}{(p^{\frac{1}{2}} - p^{-\frac{1}{2}})^{2}} \prod_{k=1}^{\infty} \frac{1}{(1-p q^k)^2 (1-p^{-1} q^k)^2 (1-q)^{12N-4}}.
$$
\end{corollary}
In the case $S \rightarrow \PP^1$ is the elliptically fibred K3 surface, this provides a new derivation of the famous Katz-Klemm-Vafa formula (recently proved in all curve classes in \cite{PT}). This is the first derivation of the KKV formula, which does \emph{not} depend on the Kawai-Yoshioka formula \cite{KY}.

The most important result of this paper is perhaps not so much the formula, but rather the method of calculation. Even though our geometry is not toric, we combine $\CC^*$-localization, motivic methods, formal methods, and $\CC^{*3}$-localization to end up with expressions, which only depend on the topological vertex, $e(B)$, and $N$. Here is a rough sketch of our method:
\begin{enumerate}
\item[(A)] The action of $\CC^*$ on the fibres of $X$ lifts to the moduli space\footnote{The bullet indicates that we take the union of $\Hilb^{B+dF,n}(X)$ over all $n$.} $\Hilb^{B+dF,\bullet}(X)$. Therefore, we only have to understand $e(\Hilb^{\beta,\bullet}(X))^{\CC^*}$. Push-forward along $X \rightarrow S \rightarrow B$ induces a map 
\begin{equation} \label{intromap}
\Hilb^{B+dF,\bullet}(X)^{\CC^*} \rightarrow \Sym^d(B).
\end{equation}
The Euler characteristics of the fibres of \eqref{intromap} give a constructible function $f_d$ on $\Sym^d(B)$. In Section \ref{sym}, we show that if $f_d$ satisfies a certain product formula, then general power structure arguments imply $\widehat{\DT}(X)$ satisfies a corresponding product formula.
\item[(B)] The fibres of \eqref{intromap} decompose into connected components according to the shape of the underlying Cohen-Macaulay curve. In Section \ref{fixedlocus}, we show this leads a decomposition over 2D partitions $\lambda = (\lambda_0 \geq \lambda_1 \geq \cdots)$.
\item[(C)] A connected component $\Sigma$ of a fibre of \eqref{intromap} can be further broken down by taking a certain fpqc cover of the underlying (now fixed) CM curve $Z_{CM}$. This cover consists of formal neighbourhoods $\widehat{X}_p$ around the singular points $p$ of the reduced support of $Z_{CM}$ and ``tubular neighbourhoods'' along the reduced support of $Z_{CM}$ after removing the singularities. Since $Z_{CM}$ is already fixed, restriction to the pieces of this cover gives a set theoretic bijection of $\Sigma$ with Hilbert schemes on the pieces of the cover. In Section \ref{formal}, we show these moves lead to the product formula for $f_d$ mentioned in (A).
\item[(D)] On the formal neighbourhoods $\widehat{X}_p$, we have an action of $\CC^{*3}$. This allows us to express their contributions in terms of the topological vertex. The contributions of tubular neighbourhoods along the \emph{punctured} section and fibres can also be expressed in terms of the topological vertex (roughly speaking, by utilizing actions of the elliptic curve $F$ or $\CC^*$ along the fibres). This is worked out in Section \ref{vertex}.
\end{enumerate}

Many of the methods of this paper work well with the Behrend function. In particular, steps (A), (B), and (D) do not provide any problems. In Section \ref{} \todo{TBC: section on Behrend function.} \\

\noindent \textbf{Acknowledgements.} We would like to thank... \todo{Add people and funding.}


\section{Definitions}

Let $p : S \rightarrow B$ be an elliptic surface over a smooth projective curve $B$. We make two assumptions:
\begin{itemize}
\item $p$ has a \emph{unique} section $B \hookrightarrow S$,
\item all singular fibres of $\pi$ are of Kodaira type $I_1$, i.e.~rational nodal fibres. 
\end{itemize}
We write $F_x$ for the fibre $p^{-1}(\{x\})$, for all closed points $x \in B$. We denote the classes of the fibre and section by $B, F \in H^2(S,\ZZ)$. Interesting examples are the elliptic surfaces $E(n)$, where $B = \PP^1$ and $S$ has $12n$ nodal fibres. For example, $E(2)$ is the elliptic K3 surface.\todo{Discuss multiple sections $E(1)$?}

Let $\beta \in H_2(S)$ be Poincar\'e dual to $B+dF$, where $d \geq 0$. Denote by $X = \mathrm{Tot}(K_S)$ the total space of the canonical bundle over $S$. Then $X$ is a non-compact Calabi-Yau 3-fold. Consider the Hilbert scheme
$$
\Hilb^{\beta,n}(X) = \{ Z \subset X \ : \ [Z] = \beta, \ \chi(\O_Z) = n\}
$$
of proper subschemes $Z \subset X$ with fixed homology class and holomorphic Euler characteristics. K.~Behrend associates to any $\CC$-scheme of finite type $Y$ a constructible function $\nu : Y \rightarrow \ZZ$ \cite{Beh}. Applied to $\Hilb^{\beta,n}(X)$, the Donaldson-Thomas invariants of $X$ can be defined as\footnote{If $X$ is a compact Calabi-Yau 3-fold, R.P.~Thomas's original definition of the DT invariant is the degree of the virtual cycle of $\Hilb^{\beta,n}(X)$ \cite{Tho}. Behrend showed that this is the same as $e(\Hilb^{\beta,n}(X),\nu)$ \cite{Beh}. The advantage of the definition by means of virtual cycles is that the construction works relative to a base. This implies deformation invariance of the invariants.} 
$$
\DT_{\beta,n}(X) := \int_{\Hilb^{\beta,n}(X)} \nu \ de := \sum_{k \in \ZZ} k \ e(\nu^{-1}(\{k\})),
$$
where $e(\cdot)$ denotes topological Euler characteristic. Many of the key properties of DT invariants are already captured by the more classical Euler characteristic version\footnote{From the point of view of \cite{JS, Bri}, there are two natural integration maps on the semi-classical Hall-algebra. One corresponds to weighing by the Behrend function. The other corresponds to weighing by the ``trivial'' constructible function which is constant equal to 1.}
$$
\widehat{\DT}_{\beta,n}(X) := \int_{\Hilb^{\beta,n}(X)} 1 \ de = e(\Hilb^{\beta,n}(X)).
$$
For brevity, we define
\begin{align*}
\Hilb^{d,n}(X) &:=\Hilb^{B+dF,n}(X), \\
\DT_{\beta,n}(X) &:= \DT_{B+dF,n}(X), \\
\widehat{\DT}_{d,n}(X) &:= \DT_{B+dF,n}(X).
\end{align*}
The generating functions of interest are
\begin{align*}
\DT(X) &:= \sum_{d \geq 0} \DT_d(X) q^d := \sum_{d \geq 0} \sum_{n \in \ZZ} \DT_{d,n}(X) p^n q^d, \\
\widehat{\DT}(X) &:= \sum_{d \geq 0} \widehat{\DT}_d(X) q^d := \sum_{d \geq 0} \sum_{n \in \ZZ} \widehat{\DT}_{d,n}(X) p^n q^d.
\end{align*}
Note that the corresponding connected series $\DT^{\conn}(X)$, $\widehat{\DT}^{\conn}(X)$ are obtained by dividing by
\begin{align*}
&\sum_{d \geq 0} \sum_{n \in \ZZ} e(\Hilb^{dF,n}(X),\nu) p^n q^d \\
&\sum_{d \geq 0} \sum_{n \in \ZZ} e(\Hilb^{dF,n}(X)) p^n q^d
\end{align*}
respectively.

Since we are dealing with generating functions and our calculations involve cut-paste methods in on the moduli space, it is useful to introduce the following notation. We define
\begin{align*}
[\Hilb^{d,\bullet}(X)] := \sum_{n \in \ZZ} [\Hilb^{d,n}(X)] p^n,
\end{align*}
which is an element of $K_0(\Var_{\CC})(\!(p)\!)$, i.e.~a Laurent series with coefficients in the Grothendieck group of varieties. We also write $\Hilb^{d,\bullet}(X)$ to denote the union of all $\Hilb^{d,n}(X)$. Therefore $\Hilb^{d,\bullet}(X)$ is a $\CC$-scheme, which is locally of finite type.


\section{Push-forward to the symmetric product} \label{sym}

The action of $\CC^*$ on the fibres of $X$ lifts to the moduli space $\Hilb^{d,\bullet}(X)$. Therefore
$$
\int_{\Hilb^{d,\bullet}(X)} 1 \ de = \int_{\Hilb^{d,\bullet}(X)^{\CC^*}} 1 \ de.
$$
Recall that 
$$
\int_{\Hilb^{d,\bullet}(X)} 1 \ de = \sum_{n \in \ZZ} p^n \int_{\Hilb^{d,n}(X)} 1 \ de \in \ZZ(\!(p)\!).
$$
We revisit the $\CC^*$-fixed point locus in detail in the Section \ref{fixedlocus}. Denote by $\Sym^d(B)$ the $d$th symmetric product of $B$. Recall that we have projections 
$$
X \stackrel{\pi}{\longrightarrow} S \stackrel{p}{\longrightarrow} B.
$$
A subscheme $Z$ of $ \Hilb^{d,\bullet}(X)^{\CC^*}$ always contains the zero section $B \subset S \subset X$. We can remove it and consider the scheme $\overline{Z \setminus B}$. There exists a morphism
\begin{align}
\begin{split} \label{rho}
\rho_{d} : &\Hilb^{d,\bullet}(X)^{\CC^*} \longrightarrow \Sym^d(B), \\
&Z \mapsto \mathrm{supp}( p_* \pi_* \O_{\overline{Z \setminus B}} ),
\end{split}
\end{align}
where $\supp(\cdot)$ denotes the scheme theoretic support, which gives an effective divisor on $B$. 
%In terms of the stratification of Proposition \ref{C^*}, it is easy to describe this map: it sends $Z$ described as in the proposition  to
%$$
%\sum_{\alpha=1}^{n} |\lambda^{(\alpha)}| x_\alpha \in \Sym^h(B).
%$$
We obtain
$$
\int_{\Hilb^{d,\bullet}(X)^{\CC^*}} 1 \ de = \int_{\Sym^d(B)} \rho_{d*}(1) \ de,
$$
where $f_d := \rho_{d*}(1)$ is a constructible function on $\Sym^d(B)$. Its value at a closed point $\mathfrak{a} = \sum_i a_i x_i$ is 
$$
f_d(\mathfrak{a}) = \int_{\rho_{d}^{-1}(\mathfrak{a})} 1 \ de.
$$
We are interested in the calculation of
$$
\widehat{\DT}(X) = \sum_{d \geq 0} \widehat{\DT}_d(X) q^d =\sum_{d \geq 0} q^d \int_{\Sym^d(B)} f_d \ de.
$$
It turns out that the constructible function $f_d : \Sym^d(B) \rightarrow \ZZ(\!(p)\!)$ has two multiplicative properties. The first one is described as follows. Denote by $B^{\sm} \subset B$ the open subset over which the fibres $F_x$ are smooth and by $B^{\sing}$ the $N$ points over which the fibres $F_x$ are singular. We can consider the restrictions of $f_d$ to $\Sym^d(B^{\sm}) \subset \Sym^d(B)$ and $\Sym^d(B^{\sing}) \subset \Sym^d(B)$. Denote by $M(q)$ the MacMahon function.
\begin{proposition} \label{mult1}
Let $d_1, d_2 \geq 0$ be such that $d_1+d_2 = d$. Then 
%there are constructible functions
%\begin{align*}
%g_{d_1} : \Sym^{d_1}(B^{\sm}) &\longrightarrow \ZZ(\!(p)\!) \\
%h_{d_2} : \Sym^{d_2}(B^{\sing}) &\longrightarrow \ZZ(\!(p)\!),
%\end{align*}
%such that for any $\sum_i a_i x_i \in \Sym^{d_1}(B^{\sm})$ and $\sum_j b_j y_j \in \Sym^{d_2}(B^{\sing})$ \todo{Forgot: points which can are off the curve.}
$$ 
f_d(\mathfrak{a} + \mathfrak{b}) =\frac{(p^{\frac{1}{2}} - p^{-\frac{1}{2}})^{e(B)}}{M(p)^{e(X)}} \cdot f_{d_1}(\mathfrak{a}) \cdot f_{d_2}(\mathfrak{b}), 
$$
for any $\mathfrak{a} \in \Sym^{d_1}(B^{\sm})$ and $\mathfrak{b} \in \Sym^{d_2}(B^{\sing})$. 
\end{proposition}
We prove this proposition in Section \ref{chargh}. The following product formula is an immediate consequence of this result
\begin{align}
\begin{split} \label{firstprod}
&\sum_{d \geq 0} q^d \int_{\Sym^d(B)} f_d \ de = \\
&\frac{(p^{\frac{1}{2}} - p^{-\frac{1}{2}})^{e(B)}}{M(p)^{e(X)}}  \Big( \sum_{d \geq 0} q^d \int_{\Sym^d(B^{\sm})} f_d \ de \Big) \cdot \Big( \sum_{d \geq 0} q^d \int_{\Sym^d(B^{\sing})} f_d \ de \Big). 
\end{split}
\end{align}
The restricted constructible functions $f_d  : \Sym^d(B^{\sm}) \rightarrow \ZZ(\!(p)\!)$ and $f_d  : \Sym^d(B^{\sing}) \rightarrow \ZZ(\!(p)\!)$ satisfy further multiplicative properties:
\begin{proposition} \label{mult2}
There exist functions $g : \ZZ_{\geq 0} \rightarrow \ZZ(\!(p)\!)$ and $h : \ZZ_{\geq 0} \rightarrow \ZZ(\!(p)\!)$, such that $g(0)=1$, $h(0)=1$, and
\begin{align*}
f_{d}(\mathfrak{a}) &= \frac{M(p)^{e(X)}}{(p^{\frac{1}{2}} - p^{-\frac{1}{2}})^{e(B)}} \cdot \prod_{i} g(a_i), \\
f_{d}(\mathfrak{b}) &= \frac{M(p)^{e(X)}}{(p^{\frac{1}{2}} - p^{-\frac{1}{2}})^{e(B)}} \cdot \prod_{j} h(b_j), 
\end{align*}
for all $d \geq 0$, $\mathfrak{a} = \sum_i a_i x_i \in \Sym^{d}(B^{\sm})$, and $\mathfrak{b} = \sum_j b_j y_j \in \Sym^{d}(B^{\sing})$.
\end{proposition}
We prove this proposition in Section \ref{chargh}. Together with Lemma \ref{lem: formula for euler char of sym products} from the appendix, Proposition \ref{mult2} and equation \eqref{firstprod} imply
\begin{equation} \label{initialprod}
\sum_{d \geq 0} q^d \int_{\Sym^d(B)} f_d \ de = \frac{M(p)^{N}}{(p^{\frac{1}{2}} - p^{-\frac{1}{2}})^{e(B)}} \cdot \Big( \sum_{a=0}^{\infty} g(a) q^a \Big)^{e(B) - N} \cdot \Big( \sum_{b=0}^{\infty} h(b) q^b \Big)^N.
\end{equation}
We want to prove Propositions \ref{mult1}, \ref{mult2}, and find formulae for $g(a)$, $h(b)$. This requires a better understanding of the strata
$$
\rho_{d}^{-1} (\mathfrak{a} + \mathfrak{b}) \subset \Hilb^{d, \bullet}(X)^{\CC^*},
$$
for all $\mathfrak{a} \in \Sym^{d_1}(B^{\sm})$ and $\mathfrak{b} \in \Sym^{d_2}(B^{\sing})$ with $d_1+d_2=d$. We continue with a more careful study of the $\CC^*$-fixed locus.


\section{The $\CC^*$-fixed locus} \label{fixedlocus}

As we already noted, the action of $\CC^*$ on the fibres of $X$ lifts to the moduli space $\Hilb^{d,\bullet}(X)$. 
%Therefore
%$$
%e(\Hilb^{d,\bullet}(X)) = e(\Hilb^{d,\bullet}(X)^{\CC^*}).
%$$
Therefore, we only need to restrict attention to $\Hilb^{d,\bullet}(X)^{\CC^*}$. 

Using the map $\pi : X \rightarrow S$, a quasi-coherent sheaf on $X$ can be viewed as a quasi-coherent sheaf $\F$ on $S$ together with a morphism $\F \otimes K_{S}^{-1} \rightarrow \F$. A $\CC^*$-equivariant structure on $\F$ translates into a $\ZZ$-grading
$$
\pi_* \F = \bigoplus_{k \in \ZZ} \F_k,
$$
such that $\F \otimes K_{S}^{-1} \rightarrow \F$ is graded, i.e.
$$
\F_k \otimes K_{S}^{-1} \longrightarrow \F_{k-1}.
$$
The structure sheaf $\O_X$ corresponds to 
$$
\pi_* \O_X = \bigoplus_{k=0}^{\infty} K_{S}^{-k}.
$$
Therefore a $\CC^*$-fixed morphism $\F \rightarrow \O_X$ corresponds to a graded sheaf $\F$ as above together with maps
\begin{displaymath}
\xymatrix
{
\cdots & \F_1 & \oplus & \F_0 \ar[d] & \oplus & \F_{-1} \ar[d] & \oplus & \F_{-2} \ar[d] & \cdots \\
& & & \O_S & \oplus & K_{S}^{-1} & \oplus & K_{S}^{-2} & \cdots 
}
\end{displaymath}
It is useful to re-define $\G_k := \F_{-k} \otimes K_{S}^{k}$. Then a $\CC^*$-fixed morphism $\F \rightarrow \O_X$ is equivalent to the following data:
\begin{itemize}
\item coherent sheaves $\{\G_k\}_{k \in \ZZ}$ on $S$,
\item morphisms $\{\G_k \rightarrow \G_{k+1}\}_{k \in \ZZ}$,
\item morphisms $\G_k \rightarrow \O_S$ such that the following diagram commutes:
\end{itemize}
\begin{displaymath}
\xymatrix
{
\cdots & \G_{-1} \ar[r] & \G_0 \ar[r] \ar[d] & \G_{1} \ar[r] \ar[d] & \G_{2} \ar[r] \ar[d] & \cdots \\
& & \O_S \ar@{=}[r]& \O_S \ar@{=}[r] & \O_S \ar@{=}[r] & \cdots 
}
\end{displaymath}
In the case of interest to us $\G \rightarrow \O_X$ is an ideal sheaf $I_Z \hookrightarrow \O_X$ cutting out $Z \subset X$. In the above language, this means $\G_k = 0$ for $k<0$, the morphisms $\G_k \rightarrow \O_S$ are injective (hence $\G_k = I_{Z_k}$ is an ideal sheaf cutting out $Z_k \subset S$), and the morphisms $\G_k \rightarrow \G_{k+1}$ are injective (hence $I_{Z_k} \subset I_{Z_{k+1}}$, i.e.~$Z_{k} \supset Z_{k+1}$). We conclude:
\begin{proposition}
A closed point $Z$ of $\Hilb^{d,\bullet}(X)^{\CC^*}$ corresponds to a finite nesting of closed subschemes of $S$
$$
Z_{0} \supset Z_{1} \supset \cdots \supset Z_{l},
$$
for some $l \geq 0$, such such that
$$
\sum_{k=0}^{l} [Z_k] = B + dF \in H_2(S).
$$
\end{proposition}

In the above proposition, each $Z_k$ contains a maximal Cohen-Macaulay subcurve $D_k$ such that $Z_k \setminus D_k$ is 0-dimensional. For $k=0$, $D_0$ is the scheme-theoretic union of the section $B$ and thickenings of certain distinct fibres $F_{x_1}$, $\ldots$, $F_{x_n}$. Denoting the orders of thickenings by $\lambda_{0}^{(1)}, \ldots, \lambda_{0}^{(n)} > 0$, we obtain\footnote{For any reduced curve $C$ on a surface $S$ with ideal sheaf $I_C \subset \O_S$ and $d>0$, we denote by $d C$ the scheme defined by the ideal sheaf $I_{C}^{d} \subset \O_S$.}
$$
D_0 = B \cup \lambda_{0}^{(1)} F_{x_1} \cup \cdots \cup \lambda_{0}^{(n)} F_{x_n}.
$$
This statement follows from Corollary \ref{cor: chow(beta) = sym (B)} of the appendix. Next, for all $i = 1, \ldots, n$ and $k \geq 1$, there are $\lambda_{k}^{(i)} \leq \lambda_{k-1}^{(i)}$ such that
$$
D_k = \lambda_{k}^{(1)} F_{x_1} \cup \cdots \cup \lambda_{k}^{(n)} F_{x_n}.
$$
We conclude:
\begin{proposition} \label{ZCM}
To each closed point $Z$ of $\Hilb^{d,\bullet}(X)^{\CC^*}$ correspond distinct closed points $x_1, \ldots, x_n \in B$ for some $n$ and (finite) 2D partitions $\lambda^{(1)}, \ldots, \lambda^{(n)}$ such that
$$
\sum_{i=1}^{n} |\lambda^{(i)}| = d.
$$
The maximal Cohen-Macaulay subcurve of $Z$ is given by the scheme-theoretic union of the zero section $B$ and the schemes with ideal sheaves
\begin{equation} \label{CMcurve}
\bigoplus_{k=0}^{\infty} \O_{S}(-\lambda_{k}^{(i)} F_{x_i}) \otimes K_{S}^{-k},
\end{equation}
for all $i = 1, \ldots, n$.
\end{proposition}

Note that in the notation of this proposition, the map $\rho_d$ defined in \eqref{rho} maps $Z$ to
$$
\sum_{i=1}^{n} |\lambda^{(i)}| x_i \in \Sym^d(B),
$$
where $|\lambda^{(i)}|$ denotes the size of the 2D partition $\lambda^{(i)}$.
%This leads to the following proposition:
%\begin{proposition} \label{C^*}
%For each $h>0$, there exists a stratification
%$$
%\Hilb^{h,\bullet}(X)^{\CC^*} = \coprod_{n=1}^{\infty} \coprod_{{\scriptsize{\begin{array}{c} \lambda^{(1)}, \ldots, \lambda^{(n)} \mathrm{s.t.} \\ \sum_{\alpha=1}^{n} |\lambda^{(\alpha)}| = h \end{array}}}} \Hilb^{h,\bullet}_{\lambda^{(1)}, \ldots, \lambda^{(n)}}(X)^{\CC^*},
%$$
%where $\Hilb^{h,\bullet}_{\lambda^{(1)}, \ldots, \lambda^{(n)}}(X)^{\CC^*}$ is the locally closed subset of subschemes $Z \subset X$ with maximal Cohen-Macaulay curve defined by the scheme-theoretic union of $B$ and schemes with ideal sheaves of the form \eqref{CMcurve} for some distinct fibre $F_{x_1}, \ldots, F_{x_n} \subset S$.
%\end{proposition}

%In this proposition, the number of points $n$ and the position of the points $x_1, \ldots, x_n \in B$ can still vary freely. We now want to refine the stratification by fixing the position of these points.

In the previous section, we considered the stratum
$$
\rho_{d}^{-1} ( \mathfrak{a} + \mathfrak{b} ) \subset \Hilb^{d, \bullet}(X)^{\CC^*},
$$
for any $\mathfrak{a} = \sum_{i=1}^{m} a_i x_i \in \Sym^{d_1}(B^{\sm})$ and $\mathfrak{b} = \sum_{j=1}^{n} b_j y_j \in \Sym^{d_2}(B^{\sing})$ satisfying $d_1+d_2=d$. Proposition \ref{ZCM} gives a decomposition of $\rho_{d}^{-1} ( \mathfrak{a} + \mathfrak{b} )$ into connected components\footnote{We use the term connected component somewhat loose: it means a subset which is both open and closed, so can be a union of actual connected components.}
\begin{equation} \label{comps}
\coprod_{{\scriptsize{\begin{array}{c} \lambda^{(1)} \vdash a_1 \\ \cdots \\ \lambda^{(m)} \vdash a_m \end{array}}}} \coprod_{\scriptsize{\begin{array}{c} \mu^{(1)} \vdash b_1 \\ \cdots \\ \mu^{(m)} \vdash b_m \end{array}}} \Sigma(x_1, \ldots, x_m, y_1, \ldots, y_n, \lambda^{(1)}, \ldots, \lambda^{(m)}, \mu^{(1)}, \ldots, \mu^{(n)}).
\end{equation}
We abbreviate these connected components by $\Sigma(\boldsymbol{x};\boldsymbol{y};\boldsymbol{\lambda};\boldsymbol{\mu})$. We see that $\Sigma(\boldsymbol{x};\boldsymbol{y};\boldsymbol{\lambda};\boldsymbol{\mu})$ can be characterized as the stratum of point $Z \in \Hilb^{d,\bullet}(X)^{\CC^*}$, for which the maximal CM subcurve $D \subset Z$ has been fixed by the data $\boldsymbol{x}, \boldsymbol{y}, \boldsymbol{\lambda}, \boldsymbol{\mu}$ as in Proposition \ref{ZCM}. We are interested in the Euler characteristics of these strata. We will see this Euler characteristic does \emph{not} depend on the exact location of the points $x_i$ and $y_j$, but only on their number $m$ and $n$ and the partitions $\lambda^{(i)}$ and $\mu^{(j)}$.


\section{Restriction to formal neighbourhoods} \label{formal}

\todo{Go back to hat notation formal nghs.} In the previous two sections, we reduced our consideration to the stratum $\Sigma(\boldsymbol{x};\boldsymbol{y};\boldsymbol{\lambda};\boldsymbol{\mu})$ containing $Z \in \Hilb^{d,\bullet}(X)^{\CC^*}$ for which the maximal CM subcurve $C \subset Z$ is fixed by the data $\boldsymbol{x}, \boldsymbol{y}, \boldsymbol{\lambda}, \boldsymbol{\mu}$. In this section, we further break down this stratum by cutting it up in pieces covered by formal neighbourhoods. For notational simplicity, we first consider the case where the base point is 
$$
a x + b y \in \Sym^2(B),
$$
with $x \in B^{\sm}$ and $y \in B^{\sing}$ and compute the Euler characteristic of $\Sigma(x,y,\lambda,\mu)$. Once this is eastablished, it is not hard to calculate the Euler characteristic of any stratum  $\Sigma(\boldsymbol{x};\boldsymbol{y};\boldsymbol{\lambda};\boldsymbol{\mu})$. This leads to a proof of Propositions \ref{mult1}, \ref{mult2}, and a geometric characterization of the functions $g(a)$, $h(b)$ of Section \ref{sym}.


\subsection{Fpqc cover}

The idea is to use an appropriate cover of $X$ and calculate on pieces of the cover. We first give a complex analytic definition of the cover to aid the intuition and then give the actual ``algebro-geometric cover'': 
\begin{itemize}
\item The reduced support $B \cup F_x \cup F_y$ has three singular points: $x,y, F_{y}^{\sing}$. We take small open balls $U_1, U_2, U_3$ around these points.
\item Consider the punctured space $X \setminus \{x,y, F_{y}^{\sing}\}$ and the following three disjoint closed curves in it $B \setminus \{x,y\}$, $F_x \setminus \{x\}$, $F_y \setminus \{y,F_{y}^{\sing}\}$. We take small tubular neighbourhoods $V_1, V_2, V_3$ of each of these curves. Note how the union of the $U_i$ and $V_i$ covers the reduced support  $B \cup F_x \cup F_y$.
\item Finally we take $W = X \setminus (B \cup F_x \cup F_y)$. 
\end{itemize}

In order to work in algebraic geometry, we let $U_1$ be the formal neighbourhood of $\{x\}$ in $X$. If $R$ is the local ring at $x$, then we mean by $U_1$ the (non-noetherian) scheme
$$
\Spec \varprojlim R / \mathfrak{m}^n 
$$
and \emph{not} the formal scheme $\mathrm{Spf} \varprojlim R / \mathfrak{m}^n$. Similarly, we let $U_2$ be the formal neighbourhood of $\{y\}$ on $X$ and $U_3$ the formal neighbourhood of $F_{y}^{\sing}$ in $X$. Note that 
$$
U_i \cong\Spec \CC[\![x_1,x_2,x_3]\!],
$$
for all $i=1,2,3$. Even though the $U_i$ are non-noetherian, the maps $U_i \rightarrow X$ are fpqc morphisms \cite{Vis}, so can be used as part of a cover. Flatness follows from the fact that localization and formal completion are exact operations \cite[Cor.~3.6, Prop.~10.12, Prop.~10.13]{AM}. 

Next, in the punctured space $X \setminus \{x,y,F_{y}^{\sing}\}$, we let $V_1$ be the formal neighbourhood of $B \setminus \{x,y\}$. Similarly, let $V_2$ be the formal neighbourhood of $F_x \setminus \{x\}$ in $X \setminus \{x,y,F_{y}^{\sing}\}$ and $V_3$ the formal neighbourhood of $F_y \setminus \{x, F_{y}^{\sing}\}$ in $X \setminus \{x,y,F_{y}^{\sing}\}$. Again, formal neighbourhoods are meant in the sense of taking Spec of of inverse limits as above. Finally, $W = X \setminus (B \cup F_x \cup F_y)$. Then
$$
\mathfrak{U} = \{U_1 \rightarrow X, U_2 \rightarrow X, U_3 \rightarrow X, V_1 \rightarrow X, V_2 \rightarrow X, V_3 \rightarrow X, W \subset X\}
$$
forms an fpqc cover of $X$. This means the data of a quasicoherent sheaf on $X$ is equivalent to the data of quasicoherent sheaves on each of the opens of $\mathfrak{U}$ together gluing isomorphisms on overlaps. Technically: quasi-coherent sheaves on $X$ form a stack with respect to the fpqc topology \cite[Thm.~4.23]{Vis}.


\subsection{Local moduli spaces} \label{localmod}

We now introduce moduli spaces of closed subschemes of dimension $\leq 1$ on each of the pieces of the cover $\mathfrak{U}$. Consider $U_1 \cong \Spec \CC[\![ x_1,x_2,x_3]\!]$ and assume the coordinates are chosen such that $x_2=x_3=0$ corresponds to the intersection of $U_1 \times_X B$ and $x_1=x_3=0$ corresponds to $U_1 \times_X F_x$. Define
$$
\Hilb^{(1,d),n}(U_1) = \big\{ I_Z \subset \O_{U_1} \ : \ [Z] = [U_1 \times_X B] + d [U_1 \times_X F_x] \ {\rm{and}} \ h^0(I_{Z_{CM}} / I_Z) = n \big\}.
$$
Here the equation
$$
[Z] = [U_1 \times_X B] + d [U_1 \times_X F_x]
$$
means $Z$ is supported along $(U_1 \times_X B) \cup (U_1 \times_X F_x)$ with multiplicity 1 along $(U_1 \times_X B)$ and multiplicity $d$ along $(U_1 \times_X F_x)$. Furthermore, $Z_{CM}$ denotes the maximal Cohen-Macaulay subcurve of $Z$ which fits into a short exact sequence
$$
0 \longrightarrow I_{Z} \longrightarrow I_{Z_{CM}} \longrightarrow Q \longrightarrow 0, 
$$
where $Q$ is a 0-dimensional. The Hilbert scheme $\Hilb^{(1,d),n}(U_2)$ is defined likewise replacing the point $x$ by $y$. (Recall that $x,y$ are intersections of $B$ with the fibres $F_x$, $F_y$.) For the point $F_{y}^{\sing}$ and its formal neighbourhood $U_3$, we define
$$
\Hilb^{d,n}(U_3) = \big\{ I_Z \subset \O_{U_3} \ : \ [Z] = d [U_3 \times_X F_y] \ {\rm{and}} \ h^0(I_{Z_{CM}} / I_Z) = n \big\}.
$$
Each $U_i$ has an action of $\CC^*$ compatible with the fibre scaling on $X$. This action lifts to the moduli space. Moreover, since $U_i \cong \Spec \CC[\![x_1,x_2,x_3]\!]$ the bigger torus $\CC^{*3}$ acts on $U_i$ and lifts to the moduli space. The existence of these ``extra actions'' are one of our main computational tools and will be used in Section \ref{vertex}.

Next consider $V_1$, the formal neighbourhood of the punctured zero section $B \subset X$. Define
$$
\Hilb^{1,n}(V_1) = \big\{ I_Z \subset \O_{V_1} \ : \ [Z] = [V_1 \times_X B] \ {\rm{and}} \ h^0(I_{Z_{CM}} / I_Z) = n \big\}.
$$
For $V_2$, $V_3$ we define
$$
\Hilb^{d,n}(V_i) = \big\{ I_Z \subset \O_{V_i} \ : \ [Z] = d [V_i \times_X B] \ {\rm{and}} \ h^0(I_{Z_{CM}} / I_Z) = n \big\}.
$$
Finally, for $W$ we define
$$
\Hilb^{0,n}(W) = \big\{ I_Z \subset \O_{V_1} \ : \ \dim(Z) = 0 \ {\rm{and}} \ h^0(\O_Z) = n \big\}.
$$
Each $V_i$ and $W$ also have an action of $\CC^*$ compatible with the fibre scaling on $X$. These actions lift to the moduli space. However, \emph{unlike} the $U_i$, no additional tori act on $V_i$, $W$.

As before, we use the notation $\Hilb^{(1,d),\bullet}(U_1)$ for the union of all $\Hilb^{(1,d),n}(U_1)$ (and similarly for all other moduli spaces of this section). Like in Section \ref{fixedlocus}, the components of the $\CC^*$-fixed locus of $\Hilb^{(1,d),\bullet}(U_1)$ are indexed by partitions $\lambda \vdash d$
$$
\Hilb^{(1,d),\bullet}(U_1)^{\CC^*} = \coprod_{\lambda \vdash d} \Hilb^{(1,d),\bullet}(U_1)_{\lambda}^{\CC^*}.
$$

\begin{proposition} \label{bij}
Consider the stratum $\Sigma(x,y,a,b)$, where $a = |\lambda|$ and $b = |\mu|$. Restriction from $X$ to the open subsets of the cover $\mathfrak{U}$ induces a morphism
\begin{align}
\begin{split} \label{restr}
\Sigma(x,y,\lambda,\mu) \longrightarrow &\Hilb^{(1,a),\bullet}(U_1)_{\lambda}^{\CC^*} \times \Hilb^{(1,b),\bullet}(U_2)_{\mu}^{\CC^*} \times \Hilb^{b,\bullet}(U_3)_{\mu}^{\CC^*} \times \\
&\Hilb^{1,\bullet}(V_1)^{\CC^*} \times \Hilb^{a,\bullet}(V_2)_{\lambda}^{\CC^*} \times \Hilb^{b,\bullet}(V_3)_{\mu}^{\CC^*} \times \\
&\Hilb^{0,\bullet}(W)^{\CC^*},
\end{split}
\end{align}
which is a bijection on closed points.
\end{proposition}
\begin{proof}
Throughout this proof, we work on closed points only.

Restriction along $U_i \rightarrow X$, $V_i \longrightarrow X$, $W \subset X$ gives the map set-theoretically. For any reduced base $B$, restriction along $U_i \times B \rightarrow X \times B$, $V_i \times B \longrightarrow X \times B$, $W \times B \subset X \times B$ gives a map between moduli functors and hence induces the above morphism.

Since $\mathfrak{U}$ is an fpqc cover, fpqc descent implies that any ideal sheaf $I_Z \subset \O_X$ is entirely determined by its restriction along $U_i \rightarrow X$, $V_i \longrightarrow X$, $W \subset X$ proving injectivity.

Conversely, given local ideal sheaves in the image of \eqref{restr}, their restrictions to overlaps only depend on the underlying Cohen-Macaulay curve (and not on the embedded points). Since we chose the strata such that the underlying Cohen-Macauly curve automatically glues, there are no further gluing conditions and fpqc descent implies surjectivity.
\end{proof}
   
\begin{remark}
Note that the argument of Proposition \ref{bij} is purely set-theoretic in nature. We do \emph{not} claim \eqref{restr} is an isomorphism of schemes. 
\end{remark}

\begin{remark}
It is important to relate holomorphic Euler characteristic of domain and target in \eqref{restr}. For any subscheme $Z$ in the domain $\Sigma(x,y,\lambda,\mu)$, denote the corresponding maximal Cohen-Macaulay curve by $Z_{CM}$ (Proposition \ref{ZCM}). Then
$$
\chi(\O_Z) = \chi(\O_{Z_{CM}}) + \chi(I_{Z_{CM}} / I_{Z}).
$$ 
Recall that $Z_{CM}$ is entirely determined by the data $x,y, \lambda, \mu$, where $\lambda = (\lambda_0 \geq \lambda_1 \geq \cdots)$ and $\mu = (\mu_0 \geq \mu_1 \geq \cdots)$ are 2D partitions \eqref{comps}. An easy calculation shows 
$$
\chi(\O_{Z_{CM}}) = \chi(\O_B) - \lambda_0 - \mu_0.
$$
We conclude
\begin{equation} \label{relchi}
\chi(\O_Z) = -\frac{e(B)}{2} - \lambda_0 - \mu_0 + \chi(I_{Z_{CM}} / I_{Z}).
\end{equation}
\end{remark}

Proposition \ref{bij} allows us to calculate the Euler characteristic of the stratum $\Sigma(x,y,\lambda,\mu)$. Recall that $a = |\lambda|$, $b=|\mu|$ so $d=a+b$. Then by \eqref{comps}, Proposition \ref{bij}, and \eqref{relchi}
\begin{align}
\begin{split} \label{fdintermediate}
f_d(ax+by) = \ &e(\rho_{d}^{-1}(ax+by)) \\
= \ &p^{-\frac{e(B)}{2}} e(\Hilb^{1,\bullet}(V_1)^{\CC^*}) e(\Hilb^{0,\bullet}(W)^{\CC^*}) \times \\
&\sum_{\lambda \vdash a} \sum_{\mu \vdash b} p^{-\frac{e(B)}{2} - \lambda_0 - \mu_0 } e(\Hilb^{(1,a),\bullet}(U_1)_{\lambda}^{\CC^*}) e(\Hilb^{(1,b),\bullet}(U_2)_{\mu}^{\CC^*}) \times \\
&\qquad\qquad e(\Hilb^{b,\bullet}(U_3)_{\mu}^{\CC^*}) e(\Hilb^{a,\bullet}(V_2)_{\lambda}^{\CC^*}) e(\Hilb^{b,\bullet}(V_3)_{\mu}^{\CC^*}).
\end{split}
\end{align}

Before we proceed, we need to calculate $e(\Hilb^{0,\bullet}(W)^{\CC^*})$ and $e(\Hilb^{1,\bullet}(V_1)^{\CC^*})$. The first follows from a formula of J.~Cheah \cite{} 
\begin{equation} \label{Cheah}
e(\Hilb^{0,\bullet}(W)^{\CC^*}) = M(p)^{e(W)}.
\end{equation}
For the second we use the following proposition:
\begin{proposition} \label{section}
Let $B^{\circ}$ be the section $B \subset S \subset X$ with any number of punctures and let $X^\circ$ be obtained from $X$ by removing the same punctures. Let $V$ be the formal neighbourhoods $V$ of $B^\circ$ in $X^\circ$. Define $\Hilb^{1,n}(V)$ as the Hilbert scheme of subschemes $Z \subset V$, such that $Z_{CM} = C$ and $\chi(I_{Z_{CM}} / I_Z) = n$, where $Z_{CM}$ denotes the maximal Cohen-Macaulay subscheme contained in $Z$ (Proposition \ref{ZCM}). Then
$$
e(\Hilb^{1,\bullet}(V)) = \bigg( \frac{M(p)}{(1-p)} \bigg)^{e(B^\circ)}.
$$
\end{proposition}
\begin{proof}
Let $p \in B^\circ$ and let $U \cong \Spec \CC [x_1,x_2,x_3]$ the formal neighbourhood of $p$ in $X^\circ$. Denote by $\Hilb^{1,n}(U)$ the Hilbert scheme of subschemes $Z \subset U$, such that $Z_{CM} = \{x_2=x_3=0\}$ and $\chi(I_{Z_{CM}} / I_Z) = n$. We have projections
$$
X^\circ \longrightarrow S^\circ \longrightarrow B^\circ.
$$
Similar to Proposition \ref{bij}, this map induces a morphism
$$
\Hilb^{1,d}(V) \longrightarrow \Sym^d(B^\circ).
$$
The fibre over a point $\mathfrak{a} = \sum_i a_i x_i$ equals
$$
\prod_{i} e(\Hilb^{1,a_i}(U)).
$$
This follows by using an appropriate fpqc cover of $B^\circ$ similar to Proposition \ref{bij}. Therefore, Lemma \ref{lem: formula for euler char of sym products} of the appendix implies
$$
e(\Hilb^{1,\bullet}(V)) = \Bigg( \sum_{a=0}^{\infty} e(\Hilb^{1,a}(U)) p^a \Bigg)^{e(B^\circ)}.
$$
Now $U$ has an action of $\CC^{*3}$ which lifts to $\Hilb^{1,a}(U)$. The fixed locus consists of a finite number of points counted by the topological vertex (discussed in general in Section \ref{vertex})
$$
\sfV_{\square,\varnothing,\varnothing}(p) = \frac{M(p)}{(1-p)}.
$$
\end{proof}

Using \eqref{Cheah} and Proposition \ref{section}, equation \eqref{fdintermediate} becomes
\begin{align*}
f_d(ax+by) = \ &\frac{M(p)^{e(X)}}{(p^{\frac{1}{2}}-p^{-\frac{1}{2}})^{e(B)}} \Big( (1-p) \sum_{\lambda \vdash a} p^{-\lambda_0} e(\Hilb^{(1,a),\bullet}(U_1)_{\lambda}^{\CC^*}) e(\Hilb^{a,\bullet}(V_2)_{\lambda}^{\CC^*}) \Big) \times \\
&\Big( (1-p) M(p)^{-1} \sum_{\mu \vdash b} p^{-\mu_0} e(\Hilb^{(1,b),\bullet}(U_2)_{\mu}^{\CC^*}) e(\Hilb^{b,\bullet}(U_3)_{\mu}^{\CC^*}) e(\Hilb^{b,\bullet}(V_3)_{\mu}^{\CC^*}) \Big).
\end{align*}

   
\subsection{Geometric characterization of $g(a)$ and $h(b)$} \label{chargh}

The arguments of the preceding two sections are straightforwardly modified to any stratum $\Sigma(\boldsymbol{x};\boldsymbol{y};\boldsymbol{\lambda};\boldsymbol{\mu})$. Let $U$ be the formal neighbourhood of any point on $B \subset S \subset X$ and define $\Hilb^{(1,a),\bullet}(U)$ as in Section \ref{localmod}. Let $U'$ be the formal neighbourhood of the singular point of any singular fibre $F \subset S \subset X$ and define $\Hilb^{b,\bullet}(U')$ as in Section \ref{localmod}. Let $V$ be the formal neighbourhood of any smooth fibre $F \setminus B$ in $X \setminus B$ and define $\Hilb^{a,\bullet}(V)$ as in Section \ref{localmod}. Let $V'$ be the formal neighbourhood of any singular fibre $F \setminus (B \cup F^{\sing})$ in $X \setminus (B \cup F^{\sing})$ and define $\Hilb^{b,\bullet}(V')$ as in Section \ref{localmod}. 

\begin{proposition} \label{geomgh}
For any $a,b>0$ define
\begin{align}
\begin{split} \label{gh}
g(a) &:= (1-p) \sum_{\lambda \vdash a} p^{-\lambda_0} e(\Hilb^{(1,a),\bullet}(U)_{\lambda}^{\CC^*}) e(\Hilb^{a,\bullet}(V)_{\lambda}^{\CC^*}), \\
h(b) &:= \frac{1-p}{M(p)} \sum_{\mu \vdash b} p^{-\mu_0} e(\Hilb^{(1,b),\bullet}(U)_{\mu}^{\CC^*}) e(\Hilb^{b,\bullet}(U')_{\mu}^{\CC^*}) e(\Hilb^{b,\bullet}(V')_{\mu}^{\CC^*}),
\end{split}
\end{align}
and let $g(0) := 1$, $h(0) :=1$. Then
\begin{align*}
f_{d}(\mathfrak{a} + \mathfrak{b}) &= \frac{M(p)^{e(X)}}{(p^{\frac{1}{2}}-p^{-\frac{1}{2}})^{e(B)}} \cdot \prod_{i} g(a_i) \cdot \prod_{j} h(b_j), 
\end{align*}
for any $\mathfrak{a} = \sum_i a_i x_i \in \Sym^{d}(B^{\sm})$ and $\mathfrak{b} = \sum_j b_j y_j \in \Sym^{d}(B^{\sing})$.
\end{proposition}
   
We immediately deduce:  
\begin{corollary} 
Propositions \ref{mult1} and \ref{mult2} are true for $g(a)$ and $h(b)$ defined by \eqref{gh}.
\end{corollary}   
   
   
\section{Reduction to the topological vertex}  \label{vertex} 

In this section, we prove Theorem \ref{main} of the introduction by expressing $g(a)$ and $h(b)$ in terms of the topological vertex. 

\subsection{The topological vertex and point contributions}   

\todo{Finish this subsection.}
We denote by 
$$
\sfV_{\lambda,\mu,\nu}(p) = \sum_{\pi} p^{|\pi|}, 
$$
the topological vertex of DT theory\footnote{In general this depends on an equivariant measure $\mathsf{w}(\pi)$ depending on equivariant parameters $s_1, s_2, s_3$. If $s_1+s_2+s_3=0$, then $\mathsf{w}(\pi) = \pm$. Since we are working with an Euler characteristic version of DT invariants, we take this sign to be 1.} \cite{MNOP2}. Here the sum is over all 3D partitions $\pi$ with outgoing legs $\lambda, \mu, \nu$ and $|\pi|$ denotes renormalized volume. 

For a partitions $\lambda$, we write $\lambda'$ for the corresponding transposed partition and define \cite{ORV}
\begin{align*}
|\lambda| = \sum_{k=0}^{\infty} \lambda_k \\
|\!|\lambda|\!| = \sum_{k=0}^{\infty} \lambda_{k}^{2}
\end{align*}

\begin{proposition} \label{vertex1}
For any $\lambda \vdash a$, $\mu \vdash b$
\begin{align*}
p^{-\lambda_0} e(\Hilb^{(1,a),\bullet}(U)_{\lambda}^{\CC^*}) &= \sfV_{\lambda,\square,\varnothing}(p), \\
p^{-\mu_0} e(\Hilb^{(1,b),\bullet}(U)_{\mu}^{\CC^*}) &= \sfV_{\mu,\square,\varnothing}(p), \\
e(\Hilb^{b,\bullet}(U')_{\mu}^{\CC^*}) &= p^{|\!|\mu|\!|} \sfV_{\mu,\mu',\varnothing}(p).
\end{align*}
\end{proposition}
\begin{proof}
Recall that $U,U' \cong \Spec \CC[\![x_1,x_2,x_3]\!]$. Therefore, there is an action of $\CC^{*3}$ on $U, U'$ and the moduli spaces $\Hilb^{(1,a),\bullet}(U)_{\lambda}^{\CC^*}$, $\Hilb^{(1,b),\bullet}(U)_{\mu}^{\CC^*}$, $\Hilb^{b,\bullet}(U')_{\mu}^{\CC^*}$. The fixed locus are isolated points corresponding to monomial ideals with asymptotics $(\lambda,\varnothing,\varnothing)$, $(\mu,\varnothing,\varnothing)$, $(\mu,\mu',\varnothing)$ respecitively\footnote{The transpose in $\mu'$ occurs, because we follow the convention of \cite{ORV}.} These monomial ideals are exactly what the topological vertex counts. 

Finally, note that the generating functions $e(\Hilb^{(1,a),\bullet}(U)_{\lambda}^{\CC^*})$, $e(\Hilb^{(1,b),\bullet}(U)_{\mu}^{\CC^*})$, $\Hilb^{b,\bullet}(U')_{\mu}^{\CC^*}$ all start with $1$. On the other hand
\begin{align*}
\sfV_{\lambda,\square,\varnothing}(p) &= p^{-\lambda_0} + \cdots, \\
\sfV_{\mu,\square,\varnothing}(p) &= p^{-\mu_0} + \cdots, \\
\sfV_{\mu,\mu',\varnothing}(p) &= p^{\sum_{k=0}^{\infty} \mu_{k}^{2}} + \cdots,
\end{align*}
where $\cdots$ stands for higher order terms.
\end{proof}

   
\subsection{Fibre contribution}

Recall that we denote by $V$ the formal neighbourhood of any smooth fibre $F \setminus B$ in $X \setminus B$ and by $V'$ be the formal neighbourhood of any singular fibre $F \setminus (B \cup F^{\sing})$ in $X \setminus (B \cup F^{\sing})$. 
\begin{proposition} \label{vertex2}
For any $\lambda \vdash a$ and $\mu \vdash b$, we have
\begin{align*}
e(\Hilb^{a,\bullet}(V)_{\lambda}^{\CC^*}) &= \frac{1}{\sfV_{\lambda,\varnothing,\varnothing}(p)}, \\
e(\Hilb^{b,\bullet}(V')_{\mu}^{\CC^*}) &= \frac{1}{\sfV_{\mu,\varnothing,\varnothing}(p)}.
\end{align*}
\end{proposition}
\begin{proof}
We start with the first equation. Let $F = F_x \subset S$ be a smooth fibre over a closed point $x \in B$. Consider the auxiliary surface $\tilde{S} = B \times F$ ($F$ a smooth elliptic curve) and $\tilde{X} = \mathrm{Tot}(K_{\tilde{S}})$. let $e \in F$ be any point and consider the embeddings 
\begin{align*}
B &\hookrightarrow \tilde{S}, \ b \mapsto (b,e) \\
\tilde{S} &\hookrightarrow \tilde{X}, \ p \mapsto (p,0).
\end{align*}
Consider the embeddings $B \subset \tilde{S} \subset \tilde{X}$ (where $\tilde{S} \subset \tilde{X}$ is the zero section) and $B \subset S \subset X$. Denote by $T$ a formal neighbourhood of $F \subset S \subset X$ and $\tilde{T}$ a formal neighbourhood of $F \cong \{x\} \times F \subset \tilde{S} \tilde{X}$ ($T$ stands for ``tubular''). Certainly $T$ and $\tilde{T}$ are \emph{not} isomorphic. Next, denote by $V$ the formal neighbourhood of $F \setminus B$ on $X \setminus B$ and by $\tilde{V}$ the formal neighbourhood of $F \setminus B$ on $\tilde{X} \setminus B$ (using the same embeddings as above). Then 
\begin{equation} \label{isopuncturednghs}
V \cong \tilde{V}.
\end{equation}
We are interested in the moduli space $\Hilb^{a,\bullet}(V)$ and the correspondingly defined moduli space $\Hilb^{a,\bullet}(\tilde{V})$. Since $V$, $\tilde{V}$ have (compatible) $\CC^*$-actions coming from scaling the fibres of $X$, $\tilde{X}$, we can consider their fixed loci and stratify them according to 2D partitions as in \ref{comps}. By \eqref{isopuncturednghs}, we have    
$$
\Hilb^{a,\bullet}(V)_{\lambda}^{\CC^*} \cong \Hilb^{a,\bullet}(\tilde{V})_{\lambda}^{\CC^*}.
$$
This observation allows us to work in the much simpler geometry of $\tilde{X}$.

Let $F \cong \{x\} \times F \subset \tilde{S}$ as above. Denote the zero section by $\tilde{S} \subset \tilde{X}$. We will use the following formal neighbourhoods (in the sense of Section \ref{formal}): 
\begin{itemize}
\item Let $\tilde{U}$ be the formal neighbourhood of $(x,e,0) \in \tilde{X}$.
\item Let $\tilde{V}$ be the formal neighbourhood of $F \setminus \{(x,e,0)\}$ inside $\tilde{X} \setminus \{(b,e,0)\}$ (introduced above).
\item Let $\tilde{T}$ be the formula neighbourhood of $F$ inside $\tilde{X}$ (introduced above).
\end{itemize}
Then $\tilde{U} \rightarrow \tilde{T}$, $\tilde{V} \rightarrow \tilde{T}$ forms an fpqc cover of $\tilde{T}$. Note that $\tilde{U} \cong \Spec \CC[x_1,x_2,x_3]$. On these pieces, we introduce moduli spaces 
\begin{align*}
\Hilb^{a,\bullet}(\tilde{U}), \ \Hilb^{a,\bullet}(\tilde{V}), \ \Hilb^{a,\bullet}(\tilde{T})
\end{align*}
exactly as in Section \ref{formal}. As in Proposition \ref{bij}, restriction gives a bijective morphism on closed points
$$
\Hilb^{a,\bullet}(\tilde{T})^{\CC^*}_{\lambda} \rightarrow \Hilb^{a,\bullet}(\tilde{U})^{\CC^*}_{\lambda} \times \Hilb^{a,\bullet}(\tilde{V})^{\CC^*}_{\lambda}.
$$

Recall that $\tilde{S} = B \times F$. Therefore $F$ does not only act on $F \subset \tilde{S}$, but for any thickening $d F \subset \tilde{S}$ it acts on $d F$. This is because
$$
\O_{dF} = \O_{db} \otimes \O_F,
$$
where $db \subset B$ denotes the $d$ times thickening of $b \in B$. Moreover, $F$ acts on the thickened curve $\lambda F \subset \tilde{X}$ defined by
$$
\bigoplus_{k=0}^{\infty} \O_{\tilde{S}}(-\lambda_k F) \otimes K_{\tilde{S}}^{-k}.
$$
Since the action of $F$ on itself is fixed-point-free, it lifts to a free action on acts freely on $\Hilb^{a,\bullet}(\tilde{T})^{\CC^*}_{\lambda}$. Since $e(F)=0$, we deduce
$$
e(\Hilb^{a,\bullet}(\tilde{T})^{\CC^*}_{\lambda}) = 1,
$$ 
where 1 comes $\bullet = 0$.

Finally, since $U \cong \Spec \CC[x_1,x_2,x_3]$, we have an action of $\CC^{*3}$ on it and 
$$
e(\Hilb^{a,\bullet}(\tilde{U})^{\CC^*}_{\lambda}) = e(\Hilb^{a,\bullet}(\tilde{U})^{\CC^{*3}}_{\lambda}) = \sfV_{\lambda,\varnothing,\varnothing}(p).
$$

The equation for $e(\Hilb^{b,\bullet}(V')_{\mu}^{\CC^*})$ follows similarly. This time, the smooth fibre $F \subset S \subset X$ is replaced by the punctured singular fibre $F' \setminus F^{\prime \sing} \subset S \setminus F^{\prime \sing} \subset X \setminus F^{\prime \sing}$. Note that
$$
F' \setminus F^{\prime \sing} \cong \PP^1 \setminus \{2 \ \rm{points}\} \cong \CC^*.
$$
Therefore, we again have a free action of $F' \setminus F^{\prime \sing}$ on itself and $e(F' \setminus F^{\prime \sing}) = 0$. The proof follows the same steps.
\end{proof}   


\subsection{Proof of Theorem \ref{main}}

Combining Proposition \ref{geomgh} with Propositions \ref{vertex1}, \ref{vertex2} immediately gives:
\begin{proposition} \label{combgh}
For any $a,b>0$ 
\begin{align}
\begin{split} \label{gh}
g(a) &:= (1-p) \sum_{\lambda \vdash a} \frac{\sfV_{\lambda,\square,\varnothing}(p)}{\sfV_{\lambda,\varnothing,\varnothing}(p)}, \\
h(b) &:= \frac{1-p}{M(p)} \sum_{\mu \vdash b} \frac{\sfV_{\mu,\square,\varnothing}(p) \sfV_{\mu,\mu',\varnothing}(p) p^{|\!|\mu|\!|}}{\sfV_{\mu,\varnothing,\varnothing}(p)}.
\end{split}
\end{align}
\end{proposition}

Plugging in the explicit expression for $g$, $h$ in Proposition \ref{combgh} into \eqref{initialprod} immediately gives the formula for $\widehat{DT}(X)$ in Theorem \ref{main}.

Following the exact same line of reasoning of Sections \ref{sym}--\ref{vertex}, it is easy to see that
\begin{align*}
\sum_{d \geq 0} \sum_{n \in \ZZ} e(\Hilb^{dF,n}(X)) p^n q^d = \Bigg( \sum_{\lambda} q^{|\lambda|} \Bigg)^{e(B) - N} \Bigg( \sum_{\mu} \sfV_{\mu,\mu',\varnothing}(p) p^{|\!|\mu|\!|} q^{|\lambda|} \Bigg)^{N}.
\end{align*}
The formula for $\widehat{DT}^{\conn}(X)$ in Theorem \ref{main} follows from dividing $\widehat{DT}(X)$ by this expression.


\section{Introducing the Behrend function}

\todo{Todo...}

\appendix
\section{Odds and Ends}\label{appendix: odds and ends}


\subsection{Weighted Euler characteristics of symmetric products}

In this section we prove the following formula for the weighted Euler
characteristic of symmetric products.

\begin{lemma}\label{lem: formula for euler char of sym products}
Let $S$ be a scheme of finite type over $\CC $ and let $e (S)$ be its
topological Euler characteristic. Let $g:\ZZ _{\geq 0}\to \ZZ ((Q))$
be any function with $g (0)=1$. Let $f_{d}:\Sym ^{d} (S)\to \ZZ ((Q))$
be the constructible function defined by $f_{d} (\sum_{i}
a_{i}x_{i})=\prod _{i}g (a_{i})$. Then
\[
\sum _{d=0}^{\infty } u^{d} \int _{\Sym ^{d} (S)} f_{d} de =
\left(\sum _{a=0}^{\infty }g (a) u^{a} \right)^{e (S)}.
\]
\end{lemma}

\begin{remark} \label{MacD}
In the special case where $g=f_{d}\equiv  1$, the lemma recovers
MacDonald's formula: $\sum _{d=1}^{\infty }e (\Sym ^{d} (S)) u^{d} =
(1-u)^{-e (S)}$. 

The lemma is essentially a consequence of the existence of a power
structure on the Grothendieck group of varieties definited by
symmetric products and the compatibility of the Euler characteristic
homomorphism with that power structure \cite{}. For convenience's
sake, we provide a direct proof here.
\end{remark}
\begin{proof}
The $d$th symmetric product admits a stratification with strata
labelled by partitions of $d$. Associated to any partition of $d$ is a
unique tuple $(m_{1},m_{2},\dots )$ of non-negative integers with
$\sum _{j=1}^{\infty }j m_{j}=d$. The stratum labelled by
$(m_{1},m_{2},\dots )$ parameterizes collections of points where there
are $m_{j}$ points of multiplicity $j$. The full stratification is
given by:
\[
\Sym ^{d} (S) = \bigsqcup_{\begin{smallmatrix} (m_{1},m_{2},\dots )\\
\sum _{j=1}^{\infty }j m_{j}=d  \end{smallmatrix}} \left\{\left(\prod _{j=1}^{\infty }S^{m_{j}} \right) -\Delta  \right\}/ \prod _{j=1}^{\infty }\sigma _{m_{j}} 
\]
where by convention, $S^{0}$ is a point, $\Delta $ is the large
diagonal, and $\sigma _{m}$ is the $m$th symmetric group. Note that
the function $f_{d}$ is constant on each stratum and has value $\prod
_{j=1}^{\infty }g (j)^{m_{j}}$. Note also that the action of $\prod
_{j=1}^{\infty }\sigma _{m_{j}}$ on each stratum is free. 

For schemes over $\CC $, topological Euler characteristic is additive
under stratification and multiplicative under maps which are
(topological) fibrations. Thus
\[
\int _{\Sym ^{d} (S)} f_{d}\,\, de = \sum _{\begin{smallmatrix}(m_{1},m_{2},\dots )\\
\sum _{j=1}^{\infty }j m_{j}=d   \end{smallmatrix}} \left(\prod _{j=1}^{\infty } g (j)^{m_{j}} \right) \frac{e (S^{\sum _{j}m_{j}}-\Delta )}{m_{1}!\, m_{2}!\, m_{3}!\dots }.
\]

For any natural number $N$, the projection $S^{N}-\Delta \to
S^{N-1}-\Delta $ has fibers of the form $S-\{N-1\text{ points}
\}$. The fibers have constant Euler characteristic given by $e (S)-
(N-1)$ and consequently, $e (S^{N}-\Delta )= (e (S)- (N-1))\cdot e
(S^{N-1}-\Delta )$. Thus by induction, we find $e (S^{N}-\Delta ) = e
(S)\cdot (e (S)-1)\cdots (e (S)- (N-1))$ and so 
\[
\frac{e (S^{\sum _{j}m_{j}}-\Delta )}{m_{1}!\,m_{2}!\,m_{3}!\cdots } = \binom{e (S)}{m_{1},m_{2},m_{3},\cdots }
\]
where the right hand side is the generalized multinomial coefficient.

Putting it together and applying the generalized multinomial theorem,
we find
\begin{align*}
\sum _{d=0}^{\infty } \int _{\Sym ^{d} (S)}f_{d}\,\,de & = \sum _{(m_{1},m_{2},\dots )} \prod _{j=1}^{\infty } \left(g (j) u^{j} \right)^{m_{j}} \binom{e (S)}{m_{1},m_{2},m_{3},\dots }\\
&=\left(1+\sum _{j=1}^{\infty }g (j) u^{j} \right)^{e (S)}
\end{align*}
which proves the lemma.   
\end{proof}

\subsection{Some geometry of curves on elliptic surfaces}\label{subsec: geometry of curves on elliptic surfaces}

In this subsection we prove the following lemma and corollary, which will tell us what is the reduced support of all curves in the class $\beta =B+dF$.

\begin{lemma}\label{lem: H0 (pi* (D) (B))=H0 (pi* (D))}
For any line bundle $\epsilon $ on $B$, multiplication by the
canonical section of $\O (B)$ induces an isomorphism
\[
H^{0} (S,\pi ^{*} (\epsilon ) (B)) \cong H^{0} (S,\pi ^{*} (\epsilon )).
\]
\end{lemma}

\begin{corollary} \label{cor: chow(beta) = sym (B)}
Let $\beta = B+dF \in H_{2} (S)$. Then the Chow variety of curves in
the class $\beta $ is isomorphic to $\Sym ^{d} (B)$ where a point
$\sum _{i}d_{i} x_{i}\in \Sym ^{d} (B)$ corresponds to the curve
$B+\sum _{i}d_{i} F_{x_{i}}$.
\end{corollary}

\begin{proof}
The corollary follows immediately from the lemma since the Chow
variety is the space of effective divisors and the lemma implies that
any effective divisor in the class $\beta $ is a union of the section
$B$ with an effective divisor pulled by from the base.

To prove lemma~\ref{lem: H0 (pi* (D) (B))=H0 (pi* (D))} we proceed as
follows. For any line bundle $\delta $ on $B$, the Leray spectral
sequence yields the short exact sequence:
\[
0\to H^{0} (B,\delta \otimes R^{1}\pi _{*}\O )\to H^{1} (S,\pi ^{*}\delta )\Rt{\alpha } H^{1} (B,\delta )\to 0,
\]
in particular, $\alpha $ is a surjection.

Then the long exact cohomology sequence associated to 
\[
0\to \pi ^{*}\delta \otimes \O (-B)\to \pi ^{*}\delta \to \O _{B}\otimes \pi ^{*}\delta \to 0
\]
is
\[
\dotsb \to H^{1} (S,\pi ^{*} (\delta ))\rt{\alpha }H^{1} (B,\delta )\to H^{2} (S,\pi ^{*}\delta \otimes \O (-B))\to H^{2} (S,\pi ^{*}\delta )\to 0,
\]
and since $\alpha $ is a surjection, we get an isomorphism of the last
two terms. We apply Serre duality to that isomorphism and we use the
fact that $K_{S} = \pi ^{*} (K_{B}\otimes L)$ where $L = \left(R\pi
_{*}\O _{S} \right)^{\vee }$ \cite[prop?]{Fr-Mo} to obtain
\[
H^{0} (S,\pi ^{*} (\delta ^{-1}\otimes K_{B}\otimes L) (B)) \cong H^{0}(S,\pi ^{*} (\delta ^{-1}\otimes K_{B}\otimes L)).
\]
Letting $\delta =K_{B}\otimes L\otimes \epsilon ^{-1}$, the lemma is
proved. 
\end{proof}


     
\begin{thebibliography}{MNOP}
%\bibitem[BCC]{BCC} J.~Bouttier, G.~Chapuy, and S.~Corteel, \textit{From Aztec diamonds to pyramids: steep tilings}, arXiv:1407.0665 [math.CO].
\bibitem[Beh]{Beh} K.~Behrend, \textit{Donaldson-Thomas type invariants via microlocal geometry}, Annals of Math.~\textbf{170} (2009), 1307--1338.
%\bibitem[BGK]{BGK} J.~Bryan, F.~Greer, and M.~Kool, \emph{in preparation}.
\bibitem[BKY]{BKY} J.~Bryan, M.~Kool, and B.~Young...
%\bibitem[BO]{BO} S.~Bloch and A.Okounkov, \textit{The character of the infinite wedge representation}, Adv.~Math.~\textbf{149} (2000), 1--60.
%\bibitem[BOP]{BOP} J.~Bryan, G.~Oberdieck, and R.~Pandharipande, \emph{in preparation}.
\bibitem[Bri]{Bri} T.~Bridgeland, \textit{An introduction to motivic Hall algebras}, Adv.~Math.~\textbf{229} (2012), 102--138.
%\bibitem[HKK]{HKK} M.-x.~Huang, S.~Katz, and A.~Klemm, \textit{Topological string on elliptic CY 3-folds and the ring of Jacobi forms}, arXiv:1501.04891 [hep-th].
\bibitem[JS]{JS} D.~Joyce and Y.~Song, \textit{A theory of generalized Donaldson-Thomas invariants}, Mem.~of the AMS \textbf{217} (2012), 1--216.
%\bibitem[Kac]{Kac} V.~Kac, \textit{Infinite dimensional Lie algebras}, Cambridge University Press (1990).
%\bibitem[KKV]{KKV} S.~Katz, A.~Klemm, and C.~Vafa, \textit{M-theory, topological strings, and spinning black holes}, Adv.~Theor.~Math.~Phys. \textbf{3} (1999), 1445--1537.
\bibitem[KY]{KY} T.~Kawai and K.~Yoshioka, \emph{String partition functions and infinite products}, Adv.~Theor.~Math.~Phys.~\textbf{4} (2000), 397--485.
%\bibitem[MNOP1]{MNOP1} D.~Maulik, N.~Nekrasov, A.~Okounkov and R.~Pandharipande, \textit{Gromov-{W}itten theory and {D}onaldson-{T}homas theory, {I}}, Compos.~Math.~\textbf{142} (2006), 1263--1285. %math.AG/0312059.
%\bibitem[MNOP2]{MNOP2} D.~Maulik, N.~Nekrasov, A.~Okounkov and R.~Pandharipande, \textit{Gromov-{W}itten theory and {D}onaldson-{T}homas theory, {II}}, Compos.~Math.~\textbf{142} (2006), 1286--1304. 
%\bibitem[MPT]{MPT} D.~Maulik, R.~Pandharipande and R.~P.~Thomas, \textit{Curves on K3 surfaces and modular forms}, J.~Topol.~\textbf{3}, 937--996 (2010). %arXiv:1001.2719.
%\bibitem[OP]{OP} A.~Okounkov and R.~Pandharipande, \textit{Gromov-Witten theory, Hurwitz theory, and completed cycles}, Annals of Math.~\textbf{163} (2006), 517?560.
%\bibitem[OPa]{OPa} G.~Oberdieck and R.~Pandharipande, \textit{Curve counting on $K3 \times E$, the Igusa cusp form $\chi_{10}$, and descendent integration}, arXiv:1411.1514 [math.AG].
%\bibitem[OR]{OR} A.~Okounkov and N.~Reshetikhin, \textit{Random skew plane partitions and the Pearcey process}, Comm.~in Math.~Phys.~\textbf{269} (2007), 571--609.
%\bibitem[ORV]{ORV} A.~Okounkov, N.~Reshetikhin, and C.~Vafa, \textit{Quantum Calabi-Yau and classical crystals}, in: The unity of mathematics, editors: P.~Etingof, V.~Retakh, I.~M.~Singer, Progress in Math.~\textbf{244}, Birkh\"auser (2006).
\bibitem[PT]{PT} R.~Pandharipande and R.~P.~Thomas, \textit{Higher genus curves on K3 surfaces and the Katz-Klemm-Vafa formula}, preprint.
%\bibitem[Sta]{Sta} R.~P.~Stanley, \textit{Enumerative combinatorics}, vol.~2, Cambridge University Press (2001).
\bibitem[Tho]{Tho} R.~P.~Thomas, \textit{A Holomorphic Casson Invariant for Calabi--Yau 3-Folds, and Bundles on K3 Fibrations}, J.~Diff.~Geom.~\textbf{54} (2000) 367--438.
%\bibitem[Tod]{Tod} Y.~Toda, \textit{Stable pairs on local K3 surfaces}, J.~Diff.~Geom.~\textbf{92} (2012), 285--370.
%\bibitem[You]{You} B.~Young, \textit{Counting coloured boxes}, PhD thesis University of British Columbia (2008).
\end{thebibliography}

\end{document}

